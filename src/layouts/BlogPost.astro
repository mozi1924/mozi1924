---
import Layout from "./Layout.astro";
import CommentSection from "../components/CommentSection";
import BusinessCard from "../components/BusinessCard.astro";
import TableOfContents from "../components/TableOfContents.astro";
import SeriesTabs from "../components/SeriesTabs.astro";
import { AUTHORS, DEFAULT_AUTHOR_ID } from "../config";

import type { CollectionEntry } from "astro:content";
import type { MarkdownHeading } from "astro";

type BlogPostFrontmatter = {
  title: string;
  date: string;
  image?: string;
  desc?: string;
  disable_comments?: boolean;
  enableBusinessCard?: boolean;
  authorId?: string;
  pageType?: "website" | "article" | "profile" | "blog";
  modDate?: string;
  hideComment?: boolean;
};

type Props = {
  frontmatter: BlogPostFrontmatter;
  headings: MarkdownHeading[];
  seriesList?: {
    title: string;
    chapters: CollectionEntry<"article">[];
  } | null;
};

import { Calendar, User, Clock } from "lucide-react";

const { frontmatter, headings, seriesList } = Astro.props;

// Resolve Author
const authorId = frontmatter.authorId || DEFAULT_AUTHOR_ID;
const author = AUTHORS[authorId] || AUTHORS[DEFAULT_AUTHOR_ID];

const showModDate =
  frontmatter.modDate && frontmatter.modDate !== frontmatter.date;

const hideComments = frontmatter.disable_comments || frontmatter.hideComment;
---

<Layout
  title={frontmatter.title}
  description={frontmatter.desc}
  image={frontmatter.image}
  pageType={frontmatter.pageType || "article"}
  pubDate={frontmatter.date}
  modDate={frontmatter.modDate}
  authorName={author.name}
  authorUrl={author.url}
  authorAvatar={author.avatar}
  authorMotto={author.motto}
  socialLinks={author.socialLinks}
  enableReadingProgress={true}
>
  <div
    id="article-main-container"
    class="relative pt-24 pb-20 px-6 max-w-7xl mx-auto"
  >
    <!-- Header -->
    <header class="text-center space-y-6 mb-16 max-w-3xl mx-auto">
      <div
        class="flex flex-wrap items-center justify-center gap-4 text-sm font-medium"
      >
        <div
          class="flex items-center gap-1.5 px-3 py-1 text-blue-400 bg-blue-500/10 rounded-full"
        >
          <Calendar className="w-4 h-4" />
          <span>{frontmatter.date}</span>
        </div>
        {
          showModDate && (
            <div
              class="flex items-center gap-1.5 px-3 py-1 text-emerald-400 bg-emerald-500/10 rounded-full"
              title="Last modified"
            >
              <Clock className="w-4 h-4" />
              <span>Updated: {frontmatter.modDate}</span>
            </div>
          )
        }
        <a
          href={author.url}
          class="flex items-center gap-1.5 px-3 py-1 text-purple-400 bg-purple-500/10 rounded-full hover:bg-purple-500/20 transition-colors"
        >
          <User className="w-4 h-4" />
          <span>{author.name}</span>
        </a>
      </div>
      <h1 class="text-4xl md:text-5xl font-bold text-white leading-tight">
        {frontmatter.title}
      </h1>
      {
        frontmatter.desc && (
          <p class="text-xl text-gray-400 leading-relaxed">
            {frontmatter.desc}
          </p>
        )
      }
      {
        frontmatter.image && !frontmatter.enableBusinessCard && (
          <div class="relative aspect-video rounded-2xl overflow-hidden shadow-2xl mt-8 border border-white/10">
            <img
              src={frontmatter.image}
              alt={frontmatter.title}
              class="w-full h-full object-cover"
            />
          </div>
        )
      }
      {
        frontmatter.enableBusinessCard && (
          <div class="lg:hidden mt-8 text-left">
            <BusinessCard authorId={authorId} />
          </div>
        )
      }
    </header>

    <div
      class={`grid gap-12 items-start ${
        frontmatter.enableBusinessCard
          ? "lg:grid-cols-[280px_1fr_250px]"
          : "lg:grid-cols-[1fr_250px]"
      }`}
    >
      {/* Business Card Sidebar (Desktop) */}
      {
        frontmatter.enableBusinessCard && (
          <aside class="hidden lg:block sticky top-24">
            <BusinessCard authorId={authorId} />
          </aside>
        )
      }

      <!-- Article Content -->
      <article
        class="min-w-0 break-words prose prose-lg prose-invert text-gray-300 max-w-none
        prose-headings:text-white prose-headings:font-bold prose-headings:scroll-mt-24
        prose-a:text-blue-400 prose-a:no-underline hover:prose-a:underline
        prose-strong:text-white prose-code:text-blue-300
        prose-pre:bg-[#1a1a1a] prose-pre:border prose-pre:border-white/10
        prose-img:rounded-xl prose-img:shadow-lg prose-img:mx-auto"
      >
        <slot />
      </article>

      <!-- Table of Contents / Series Sidebar -->
      <aside class="hidden lg:block sticky top-24 space-y-4">
        {
          seriesList ? (
            <SeriesTabs seriesList={seriesList} headings={headings} />
          ) : (
            <TableOfContents headings={headings} />
          )
        }
      </aside>
    </div>
  </div>

  {/* Mobile TOC Logic (Button + Overlay) */}
  <TableOfContents
    headings={headings}
    seriesList={seriesList}
    hideOnDesktop={true}
  />

  {/* Comment Section */}
  {
    !hideComments && (
      <div class="max-w-5xl mx-auto px-4 md:px-6 pb-20">
        <CommentSection client:load siteId="mozi1924.com" />
      </div>
    )
  }
</Layout>

<script>
  import { initTOC } from "../scripts/toc";

  document.addEventListener("astro:page-load", () => {
    initTOC();
  });
</script>
