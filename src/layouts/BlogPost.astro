---
import Layout from "./Layout.astro";
import type { MarkdownLayoutProps } from "astro";
import CommentSection from "../components/CommentSection";
import BusinessCard from "../components/BusinessCard.astro";
import { SITE } from "../config";

type Props = MarkdownLayoutProps<{
  title: string;
  date: string;
  image?: string;
  desc?: string;
  disable_comments?: boolean;
  enableBusinessCard?: boolean;
}>;

import { List, X } from "lucide-react";

const { frontmatter, headings } = Astro.props;
---

<Layout
  title={frontmatter.title}
  description={frontmatter.desc}
  image={frontmatter.image}
>
  <div class="relative pt-24 pb-20 px-6 max-w-7xl mx-auto">
    <!-- Header -->
    <header class="text-center space-y-6 mb-16 max-w-3xl mx-auto">
      <div
        class="inline-block px-3 py-1 text-sm text-blue-400 bg-blue-500/10 rounded-full"
      >
        {frontmatter.date}
      </div>
      <h1 class="text-4xl md:text-5xl font-bold text-white leading-tight">
        {frontmatter.title}
      </h1>
      {
        frontmatter.desc && (
          <p class="text-xl text-gray-400 leading-relaxed">
            {frontmatter.desc}
          </p>
        )
      }
      {
        frontmatter.image && !frontmatter.enableBusinessCard && (
          <div class="relative aspect-video rounded-2xl overflow-hidden shadow-2xl mt-8 border border-white/10">
            <img
              src={frontmatter.image}
              alt={frontmatter.title}
              class="w-full h-full object-cover"
            />
          </div>
        )
      }
      {
        frontmatter.enableBusinessCard && (
          <div class="lg:hidden mt-8 text-left">
            <BusinessCard />
          </div>
        )
      }
    </header>

    <div
      class={`grid gap-12 items-start ${frontmatter.enableBusinessCard ? "lg:grid-cols-[280px_1fr_250px]" : "lg:grid-cols-[1fr_250px]"}`}
    >
      {/* Business Card Sidebar (Desktop) */}
      {
        frontmatter.enableBusinessCard && (
          <aside class="hidden lg:block sticky top-24">
            <BusinessCard />
          </aside>
        )
      }

      <!-- Article Content -->
      <article
        class="min-w-0 break-words prose prose-lg prose-invert text-gray-300 max-w-none
        prose-headings:text-white prose-headings:font-bold prose-headings:scroll-mt-24
        prose-a:text-blue-400 prose-a:no-underline hover:prose-a:underline
        prose-strong:text-white prose-code:text-blue-300
        prose-pre:bg-[#1a1a1a] prose-pre:border prose-pre:border-white/10
        prose-img:rounded-xl prose-img:shadow-lg prose-img:mx-auto"
      >
        <slot />
      </article>

      <!-- Mobile TOC Button (Bottom Right) -->
      <div class="lg:hidden fixed bottom-6 right-6 z-40">
        <button
          id="mobile-toc-btn"
          class="bg-[#1a1a1a]/90 backdrop-blur-md border border-white/10 text-white p-3 rounded-full shadow-2xl flex items-center justify-center transition-transform active:scale-95"
          aria-label="Table of Contents"
        >
          <List className="w-6 h-6" />
        </button>
      </div>

      <!-- Mobile TOC Menu (Bottom Sheet) -->
      <div
        id="mobile-toc-overlay"
        class="lg:hidden fixed inset-0 z-50 bg-black/60 opacity-0 pointer-events-none transition-opacity duration-300"
      >
        <!-- Close on click outside -->
        <div class="absolute inset-0" id="mobile-toc-backdrop"></div>

        <div
          id="mobile-toc-sheet"
          class="absolute bottom-0 left-0 w-full max-h-[70vh] bg-[#1a1a1a] rounded-t-2xl border-t border-white/10 shadow-2xl transform translate-y-full transition-transform duration-300 flex flex-col"
        >
          <div
            class="p-4 border-b border-white/10 flex items-center justify-between"
          >
            <h3 class="text-white font-bold text-lg">Table of Contents</h3>
            <button
              id="mobile-toc-close"
              class="text-gray-400 hover:text-white p-1"
            >
              <X className="w-6 h-6" />
            </button>
          </div>
          <div class="overflow-y-auto p-4 space-y-1">
            {
              headings.map((heading) => (
                <a
                  href={`#${heading.slug}`}
                  class={`mobile-toc-link block py-3 text-sm transition-colors border-l-2 pl-4 text-gray-400 border-transparent active:bg-white/5 active:text-white
                                    ${heading.depth > 3 ? "hidden" : ""}
                                    ${heading.depth === 3 ? "ml-4" : ""}
                                `}
                >
                  {heading.text}
                </a>
              ))
            }
          </div>
        </div>
      </div>

      <!-- Table of Contents (Desktop) -->
      <aside class="hidden lg:block sticky top-24 space-y-4">
        <div
          class="p-6 bg-[#1a1a1a] rounded-xl border border-white/5 shadow-lg"
        >
          <h2 class="text-white font-bold mb-4 flex items-center gap-2">
            <List className="w-5 h-5" />
            On this page
          </h2>
          <nav class="space-y-1">
            {
              headings.map((heading) => (
                <a
                  href={`#${heading.slug}`}
                  class={`toc-link block py-1 text-sm transition-colors border-l-2 pl-4 text-gray-400 border-transparent hover:text-gray-200 hover:border-gray-500
                    ${heading.depth > 3 ? "hidden" : ""}
                    ${heading.depth === 3 ? "ml-4" : ""}
                  `}
                >
                  {heading.text}
                </a>
              ))
            }
          </nav>
        </div>
      </aside>
    </div>
  </div>
  {
    /* Comment Section (Outside the grid to span full width or constrained as needed) */
  }
  {
    !frontmatter.disable_comments && (
      <div class="max-w-5xl mx-auto px-4 md:px-6 pb-20">
        {/* Construct unique ID using configured domain only, as requested */}
        <CommentSection client:load siteId={SITE.domain} />
      </div>
    )
  }
</Layout>

<script>
  const setupObserver = () => {
    const observer = new IntersectionObserver((entries) => {
      entries.forEach((entry) => {
        const id = entry.target.getAttribute("id");
        if (entry.intersectionRatio > 0) {
          // Update Desktop TOC
          document.querySelectorAll(".toc-link").forEach((link) => {
            link.classList.remove(
              "text-[#3F89FC]",
              "border-[#3F89FC]",
              "font-bold",
            );
            link.classList.add("text-gray-400", "border-transparent");
          });

          const activeLink = document.querySelector(`.toc-link[href="#${id}"]`);
          if (activeLink) {
            activeLink.classList.remove("text-gray-400", "border-transparent");
            activeLink.classList.add(
              "text-[#3F89FC]",
              "border-[#3F89FC]",
              "font-bold",
            );
          }

          // Mobile TOC Styling (optional, simplified for mobile)
          document.querySelectorAll(".mobile-toc-link").forEach((link) => {
            link.classList.remove("text-white", "border-blue-500");
            link.classList.add("text-gray-400", "border-transparent");
          });
          const activeMobileLink = document.querySelector(
            `.mobile-toc-link[href="#${id}"]`,
          );
          if (activeMobileLink) {
            activeMobileLink.classList.remove(
              "text-gray-400",
              "border-transparent",
            );
            activeMobileLink.classList.add("text-white", "border-blue-500");
          }
        }
      });
    });

    // Track all headings that have an id
    document.querySelectorAll("article h2, article h3").forEach((heading) => {
      observer.observe(heading);
    });
  };

  const setupMobileTOC = () => {
    const btn = document.getElementById("mobile-toc-btn");
    const overlay = document.getElementById("mobile-toc-overlay");
    const sheet = document.getElementById("mobile-toc-sheet");
    const backdrop = document.getElementById("mobile-toc-backdrop");
    const closeBtn = document.getElementById("mobile-toc-close");
    const links = document.querySelectorAll(".mobile-toc-link");

    if (btn && overlay && sheet && backdrop && closeBtn) {
      const openMenu = () => {
        overlay.classList.remove("opacity-0", "pointer-events-none");
        sheet.classList.remove("translate-y-full");
      };

      const closeMenu = () => {
        sheet.classList.add("translate-y-full");
        overlay.classList.add("opacity-0", "pointer-events-none");
      };

      btn.onclick = openMenu;
      backdrop.onclick = closeMenu;
      closeBtn.onclick = closeMenu;

      links.forEach((link) => {
        link.addEventListener("click", closeMenu);
      });
    }
  };

  // Run on invalidation (view transitions)
  const init = () => {
    setupObserver();
    setupMobileTOC();
  };

  document.addEventListener("astro:page-load", init);
</script>
