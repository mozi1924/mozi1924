---
import "../styles/global.css";
import Header from "../components/Header.astro";
import Footer from "../components/Footer.astro";
import Analytics from "../components/Analytics.astro";
import { ClientRouter } from "astro:transitions";
import { SITE } from "../config";

interface Props {
	title?: string;
	description?: string;
	image?: string;
	pageType?: "website" | "article";
	pubDate?: string | Date;
	modDate?: string | Date;
	authorName?: string;
	authorUrl?: string;
}

const {
	title = "Mozi's website",
	description = "Mozi's personal website featuring Blender 3D animations, Minecraft rigs, and plugins.",
	image = "/favicon.svg",
	pageType = "website",
	pubDate,
	modDate,
	authorName = "Mozi1924",
	authorUrl = `${SITE.url}/about`,
} = Astro.props;

const canonicalURL = new URL(Astro.url.pathname, Astro.site);
const resolvedImage = new URL(image, Astro.site).href;

// JSON-LD Logic
const { pathname } = Astro.url;
const segments = pathname.split("/").filter((s) => s);

const breadcrumbs = [
	{
		name: "Home",
		item: SITE.url,
	},
	...segments.map((segment, index) => {
		const path = segments.slice(0, index + 1).join("/");
		return {
			name: decodeURIComponent(segment)
				.replace(/-/g, " ")
				.replace(/\b\w/g, (c) => c.toUpperCase()),
			item: new URL(path, SITE.url).href,
		};
	}),
];

const schema: any = {
	"@context": "https://schema.org",
	"@graph": [
		{
			"@type": "WebSite",
			"@id": `${SITE.url}/#website`,
			url: SITE.url,
			name: SITE.domain,
			description: "Mozi's personal website",
			publisher: {
				"@type": "Person",
				name: authorName,
				url: authorUrl,
				logo: {
					"@type": "ImageObject",
					url: new URL("/favicon.svg", SITE.url).href,
				},
			},
		},
		{
			"@type": "BreadcrumbList",
			"@id": `${canonicalURL.href}/#breadcrumb`,
			itemListElement: breadcrumbs.map((crumb, index) => ({
				"@type": "ListItem",
				position: index + 1,
				name: crumb.name,
				item: crumb.item,
			})),
		},
	],
};

if (pageType === "article") {
	schema["@graph"].push({
		"@type": "BlogPosting",
		"@id": `${canonicalURL.href}/#article`,
		url: canonicalURL.href,
		headline: title,
		description: description,
		image: {
			"@type": "ImageObject",
			url: resolvedImage,
		},
		datePublished: pubDate ? new Date(pubDate).toISOString() : undefined,
		dateModified:
			modDate || pubDate
				? new Date(modDate || pubDate!).toISOString()
				: undefined,
		author: {
			"@type": "Person",
			name: authorName,
			url: authorUrl,
		},
		isPartOf: { "@id": `${SITE.url}/#website` },
		mainEntityOfPage: { "@id": canonicalURL.href },
		breadcrumb: { "@id": `${canonicalURL.href}/#breadcrumb` },
	});
} else {
	schema["@graph"].push({
		"@type": "WebPage",
		"@id": `${canonicalURL.href}/#webpage`,
		url: canonicalURL.href,
		name: title,
		description: description,
		isPartOf: { "@id": `${SITE.url}/#website` },
		breadcrumb: { "@id": `${canonicalURL.href}/#breadcrumb` },
	});
}
---

<!doctype html>
<html lang="en" class="scroll-smooth">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width" />
		<link rel="icon" type="image/svg+xml" href="/favicon.svg" />
		<link rel="alternate icon" href="/favicon.ico" />
		<meta name="generator" content={Astro.generator} />
		<link rel="canonical" href={canonicalURL} />
		<meta name="robots" content="max-image-preview:large" />
		<title>{title}</title>
		<meta name="description" content={description} />
		<meta
			name="keywords"
			content="mozi1924, Mozi Arasaka, Blender, Animation, Minecraft, Rigging, Web Development, Arch Linux"
		/>

		<!-- Open Graph -->
		<meta property="og:type" content="website" />
		<meta property="og:logo" content="/favicon.svg" />
		<meta property="og:url" content={canonicalURL} />
		<meta property="og:title" content={title} />
		<meta property="og:description" content={description} />
		<meta property="og:image" content={new URL(image, Astro.url)} />

		<!-- Twitter -->
		<meta property="twitter:card" content="summary_large_image" />
		<meta property="twitter:url" content={canonicalURL} />
		<meta property="twitter:title" content={title} />
		<meta property="twitter:description" content={description} />
		<meta property="twitter:image" content={new URL(image, Astro.url)} />

		<Analytics />
		<ClientRouter />
		<script type="application/ld+json" set:html={JSON.stringify(schema)} />
	</head>
	<body
		class="scroll-smooth bg-[#111] text-white font-sans antialiased min-h-screen flex flex-col"
	>
		<Header />
		<main class="flex-grow pt-16" transition:animate="fade">
			<slot />
		</main>
		<Footer />
	</body>
</html>

<style>
	html,
	body {
		margin: 0;
		width: 100%;
		height: 100%;
	}
</style>
