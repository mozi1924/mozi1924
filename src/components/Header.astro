---
import { Menu, X } from "lucide-react";
import { NAV_LINKS } from "../menu";

interface Props {
  enableReadingProgress?: boolean;
}

const { enableReadingProgress = false } = Astro.props;

const { pathname } = Astro.url;
const normalizePath = (path: string) => {
  const p = path.replace(/\/$/, "") || "/";
  return p;
};
const currentPath = normalizePath(pathname);
---

<header
  class="fixed top-0 w-full z-50 bg-[#111]/80 backdrop-blur-md border-b border-white/10 transition-all duration-300"
>
  <div
    class="max-w-7xl mx-auto px-6 h-16 flex items-center justify-between relative z-50 bg-[#1110]"
  >
    <a href="/" class="flex items-center gap-2 group">
      <div class="relative w-8 h-8 flex items-center justify-center">
        <img
          src="/favicon.svg"
          alt="Mozi Logo"
          class="w-8 h-8 group-hover:scale-110 transition-transform duration-300"
        />
      </div>
      <span class="font-bold text-lg tracking-tight">Mozi's website</span>
    </a>

    <nav class="hidden md:flex items-center gap-8">
      {
        NAV_LINKS.map((link) => {
          const isActive =
            link.href === "/"
              ? currentPath === "/"
              : currentPath.startsWith(link.href);
          return (
            <a
              href={link.href}
              class={`text-sm font-medium transition-colors ${
                isActive ? "text-[#3F89FC]" : "text-gray-300 hover:text-white"
              }`}
            >
              {link.name}
            </a>
          );
        })
      }
    </nav>

    <button
      id="mobile-menu-btn"
      class="md:hidden text-white p-2 focus:outline-none relative w-10 h-10 flex items-center justify-center"
      aria-label="Toggle menu"
    >
      <div class="relative w-6 h-6">
        <Menu
          className="w-6 h-6 absolute inset-0 transition-all duration-300 opacity-100 rotate-0 scale-100"
          id="menu-icon-open"
        />
        <X
          className="w-6 h-6 absolute inset-0 transition-all duration-300 opacity-0 -rotate-90 scale-50"
          id="menu-icon-close"
        />
      </div>
    </button>
  </div>

  <!-- Mobile Menu -->
  <div
    id="mobile-menu"
    class="md:hidden fixed top-16 left-0 w-full h-[calc(100vh-4rem)] bg-[#111] transition-all duration-500 ease-in-out transform translate-y-[-100%] opacity-0 pointer-events-none z-40 border-b border-white/10"
  >
    <nav
      class="h-full flex flex-col items-center justify-center overflow-y-auto"
    >
      <div class="flex flex-col items-center space-y-8 p-8 w-full max-w-md">
        {
          NAV_LINKS.map((link) => {
            const isActive =
              link.href === "/"
                ? currentPath === "/"
                : currentPath.startsWith(link.href);
            return (
              <a
                href={link.href}
                class={`mobile-link text-2xl font-medium transition-colors ${
                  isActive ? "text-[#3F89FC]" : "text-gray-300 hover:text-white"
                }`}
              >
                {link.name}
              </a>
            );
          })
        }
      </div>
    </nav>
  </div>

  <!-- Reading Progress Bar -->
  {
    enableReadingProgress && (
      <div
        id="reading-progress-container"
        class="absolute bottom-0 left-0 w-full h-1 bg-transparent z-50 pointer-events-none"
      >
        <div
          id="reading-progress-bar"
          class="h-full bg-[#3F89FC] shadow-[0_0_15px_#3F89FC] w-0 transition-all duration-100 ease-out"
        />
      </div>
    )
  }

  <!-- Page Load Progress Bar -->
  <div
    id="page-load-progress-bar"
    class="fixed top-0 left-0 h-1 bg-white z-[100] transition-all duration-200 ease-out opacity-0 w-0 pointer-events-none shadow-[0_0_10px_rgba(255,255,255,0.5)]"
    transition:persist
  >
  </div>
</header>

<script>
  import { initProgressBar } from "../scripts/progress-bar";
  import { initReadingProgress } from "../scripts/reading-progress";

  // Initialize global progress bar (runs once due to singleton check)
  initProgressBar();

  const setupMobileMenu = () => {
    const btn = document.getElementById("mobile-menu-btn");
    const menu = document.getElementById("mobile-menu");
    const iconOpen = document.getElementById("menu-icon-open");
    const iconClose = document.getElementById("menu-icon-close");
    const mobileLinks = document.querySelectorAll(".mobile-link");

    if (btn && menu && iconOpen && iconClose) {
      let isOpen = false;

      const toggleMenu = (forceClose = false) => {
        const shouldClose = forceClose || isOpen;
        const header = document.querySelector("header");

        if (shouldClose) {
          // Close
          menu.classList.add(
            "translate-y-[-100%]",
            "opacity-0",
            "pointer-events-none",
          );
          menu.classList.remove(
            "translate-y-0",
            "opacity-100",
            "pointer-events-auto",
          );

          // Icon state
          iconOpen.classList.remove("opacity-0", "rotate-90", "scale-50");
          iconOpen.classList.add("opacity-100", "rotate-0", "scale-100");

          iconClose.classList.remove("opacity-100", "rotate-0", "scale-100");
          iconClose.classList.add("opacity-0", "-rotate-90", "scale-50");

          // Header background state
          header?.classList.remove("bg-[#111]", "backdrop-blur-none");
          header?.classList.add("bg-[#111]/80", "backdrop-blur-md");

          document.body.style.overflow = "";
          isOpen = false;
        } else {
          // Open
          menu.classList.remove(
            "translate-y-[-100%]",
            "opacity-0",
            "pointer-events-none",
          );
          menu.classList.add(
            "translate-y-0",
            "opacity-100",
            "pointer-events-auto",
          );

          // Icon state
          iconOpen.classList.remove("opacity-100", "rotate-0", "scale-100");
          iconOpen.classList.add("opacity-0", "rotate-90", "scale-50");

          iconClose.classList.remove("opacity-0", "-rotate-90", "scale-50");
          iconClose.classList.add("opacity-100", "rotate-0", "scale-100");

          // Header background state
          header?.classList.remove("bg-[#111]/80", "backdrop-blur-md");
          header?.classList.add("bg-[#111]", "backdrop-blur-none");

          document.body.style.overflow = "hidden";
          isOpen = true;
        }
      };

      btn.onclick = (e) => {
        e.stopPropagation();
        toggleMenu();
      };

      // Close menu when clicking links
      mobileLinks.forEach((link) => {
        link.addEventListener("click", () => toggleMenu(true));
      });

      // Reset state on resize
      const handleResize = () => {
        if (window.innerWidth >= 768 && isOpen) {
          toggleMenu(true);
        }
      };
      window.addEventListener("resize", handleResize);
    }
  };

  document.addEventListener("astro:page-load", () => {
    setupMobileMenu();
    initReadingProgress();
  });

  // Fallback for initial load
  if (document.readyState === "complete") {
    setupMobileMenu();
    initReadingProgress();
  } else {
    document.addEventListener("DOMContentLoaded", () => {
      setupMobileMenu();
      initReadingProgress();
    });
  }
</script>
