---
import { Menu, X } from "lucide-react";
import { NAV_LINKS } from "../../menu";
import { SITE } from "../../config";
import Search from "../search/Search.astro";

interface Props {
  enableReadingProgress?: boolean;
}

const { enableReadingProgress = false } = Astro.props;

const { pathname } = Astro.url;
const normalizePath = (path: string) => {
  const p = path.replace(/\/$/, "") || "/";
  return p;
};
const currentPath = normalizePath(pathname);
---

<header
  id="main-header"
  class="fixed top-0 w-full z-50 pointer-events-none group"
  transition:persist
>
  <!-- Background Layer -->
  <div
    id="header-bg"
    class="absolute inset-0 h-16 bg-[#111]/80 backdrop-blur-md border-b border-white/10 transition-[border-color] duration-500 z-10 pointer-events-auto"
  >
  </div>

  <!-- Content Layer -->
  <div
    class="max-w-7xl mx-auto px-6 h-16 flex items-center relative z-30 pointer-events-auto"
  >
    <!-- Left: Logo -->
    <div class="flex-1 flex items-center">
      <a href="/" class="flex items-center gap-2 group/logo text-white">
        <div class="relative w-8 h-8 flex items-center justify-center">
          <img
            src={SITE.favicon}
            alt={`${SITE.title} Logo`}
            class="w-8 h-8 group-hover/logo:scale-110 transition-transform duration-300"
          />
        </div>
        <span class="font-bold text-lg tracking-tight">{SITE.title}</span>
      </a>
    </div>

    <!-- Center: Navigation Links -->
    <nav
      id="desktop-nav"
      class="hidden md:flex items-center gap-1 relative px-1 py-1 bg-white/[0.03] rounded-xl border border-white/5"
    >
      <div
        id="nav-indicator"
        class="absolute bg-white/10 rounded-lg transition-all duration-300 ease-out z-0 pointer-events-none opacity-0"
      >
      </div>
      {
        NAV_LINKS.map((link) => {
          const isActive =
            link.href === "/"
              ? currentPath === "/"
              : currentPath.startsWith(link.href);
          return (
            <a
              href={link.href}
              data-nav-link
              data-href={link.href}
              class={`relative z-10 text-sm font-medium transition-colors px-4 py-2 rounded-lg group/link ${
                isActive ? "text-[#3F89FC]" : "text-gray-300 hover:text-white"
              }`}
            >
              {/* Separate hover background - only fades in/out, doesn't move */}
              <div class="absolute inset-0 bg-white/[0.04] rounded-lg opacity-0 group-hover/link:opacity-100 transition-opacity duration-200 -z-10 pointer-events-none" />
              {link.name}
            </a>
          );
        })
      }
    </nav>

    <!-- Right: Actions -->
    <div class="flex-1 flex items-center justify-end gap-2">
      <Search variant="icon" type="trigger" />
      <button
        id="mobile-menu-btn"
        class="md:hidden text-gray-400 hover:text-white hover:bg-white/5 rounded-lg transition-all focus:outline-none relative w-10 h-10 flex items-center justify-center"
        aria-label="Toggle menu"
      >
        <div class="relative w-6 h-6">
          <div
            id="menu-icon-open"
            class="absolute inset-0 flex items-center justify-center origin-center"
          >
            <Menu className="w-6 h-6" />
          </div>
          <div
            id="menu-icon-close"
            class="absolute inset-0 flex items-center justify-center origin-center"
          >
            <X className="w-6 h-6" />
          </div>
        </div>
      </button>
    </div>
  </div>

  <!-- Reading Progress Bar -->
  <div
    id="reading-progress-container"
    class="absolute top-16 left-0 w-full h-1 bg-transparent z-40 pointer-events-none opacity-0 transition-opacity duration-300"
  >
    <div
      id="reading-progress-bar"
      class="h-full bg-[#3F89FC] shadow-[0_0_15px_#3F89FC] w-0 transition-all duration-100 ease-out"
    >
    </div>
  </div>

  <!-- Mobile Menu - Now inside header for stacking context -->
  <div id="mobile-menu" class="md:hidden menu-transition">
    <nav
      id="mobile-menu-content"
      class="h-full flex flex-col items-center pt-24 pb-8 px-6 opacity-0 content-transition overflow-y-auto"
    >
      <div
        id="mobile-links-container"
        class="flex flex-col items-center space-y-4 w-full max-w-[280px] relative"
      >
        <div
          id="mobile-nav-indicator"
          class="absolute bg-white/10 rounded-lg transition-all duration-300 ease-out z-0 pointer-events-none opacity-0"
        >
        </div>
        {
          NAV_LINKS.map((link) => {
            const isActive =
              link.href === "/"
                ? currentPath === "/"
                : currentPath.startsWith(link.href);
            return (
              <a
                href={link.href}
                data-mobile-link
                data-href={link.href}
                class={`mobile-link relative z-10 text-2xl font-medium transition-colors px-6 py-3 rounded-lg group/mobile-link w-full text-center ${
                  isActive ? "text-[#3F89FC]" : "text-gray-300 hover:text-white"
                }`}
              >
                <div class="absolute inset-0 bg-white/[0.04] rounded-lg opacity-0 group-hover/mobile-link:opacity-100 transition-opacity duration-200 -z-10 pointer-events-none" />
                {link.name}
              </a>
            );
          })
        }
      </div>
    </nav>
  </div>
</header>

<!-- Page Load Progress Bar -->
<div
  id="page-load-progress-bar"
  class="fixed top-0 left-0 h-1 bg-white z-[100] transition-all duration-200 ease-out opacity-0 w-0 pointer-events-none shadow-[0_0_10px_rgba(255,255,255,0.5)]"
  transition:persist
>
</div>

<style>
  /* Transition definitions */
  .menu-transition {
    position: fixed;
    inset: 0;
    height: 100vh;
    background-color: #111;
    z-index: 20;
    clip-path: inset(0 0 100% 0);
    opacity: 0;
    transition:
      clip-path 0.6s cubic-bezier(0.32, 0.72, 0, 1),
      opacity 0.4s ease;
    will-change: clip-path, opacity;
    pointer-events: none;
  }

  .content-transition {
    transition: opacity 0.4s ease;
    transition-delay: 0.1s;
  }

  /* Menu open state */
  #mobile-menu.is-open {
    clip-path: inset(0 0 0 0);
    opacity: 1;
    pointer-events: auto;
  }

  #mobile-menu.is-open #mobile-menu-content {
    opacity: 1;
  }

  /* Header open state */
  header.is-menu-open #header-bg {
    border-color: transparent;
  }

  /* Hide scrollbar for mobile menu content */
  #mobile-menu-content {
    -ms-overflow-style: none; /* IE and Edge */
    scrollbar-width: none; /* Firefox */
  }

  #mobile-menu-content::-webkit-scrollbar {
    display: none;
  }

  /* Icon Animations */
  #menu-icon-open,
  #menu-icon-close {
    transition:
      transform 0.4s cubic-bezier(0.32, 0.72, 0, 1),
      opacity 0.4s ease;
  }

  /* Initial states */
  #menu-icon-open {
    opacity: 1;
    transform: rotate(0) scale(1);
  }

  #menu-icon-close {
    opacity: 0;
    transform: rotate(-90deg) scale(0.5);
  }

  /* Active states via header class */
  header.is-menu-open #menu-icon-open {
    opacity: 0;
    transform: rotate(90deg) scale(0.5);
  }

  header.is-menu-open #menu-icon-close {
    opacity: 1;
    transform: rotate(0) scale(1);
  }
</style>
<script>
  import { initProgressBar } from "../../scripts/progress-bar";
  import { scrollLock } from "../../utils/scroll-lock";

  const setupMobileMenu = () => {
    const btn = document.getElementById("mobile-menu-btn");
    const menu = document.getElementById("mobile-menu");
    const header = document.querySelector("header");
    const mobileLinks = document.querySelectorAll(".mobile-link");
    const container = document.getElementById("mobile-links-container");
    const indicator = document.getElementById("mobile-nav-indicator");

    if (btn && menu && header && container && indicator) {
      let isOpen = false;
      let openTimeout: ReturnType<typeof setTimeout> | undefined;

      const updateIndicator = (el: Element | null) => {
        if (el) {
          const target = el as HTMLElement;
          const rect = target.getBoundingClientRect();
          const containerRect = container.getBoundingClientRect();

          indicator.style.width = `${rect.width}px`;
          indicator.style.height = `${rect.height}px`;
          indicator.style.left = `${rect.left - containerRect.left}px`;
          indicator.style.top = `${rect.top - containerRect.top}px`;
          indicator.style.opacity = "1";
        } else {
          indicator.style.opacity = "0";
        }
      };

      const getActiveLink = () => {
        const pathname = window.location.pathname;
        const normalizePath = (path: string) => path.replace(/\/$/, "") || "/";
        const currentPath = normalizePath(pathname);

        let activeLink: Element | null = null;
        mobileLinks.forEach((link) => {
          const href = link.getAttribute("data-href");
          const isActive =
            href === "/" ? currentPath === "/" : currentPath.startsWith(href!);
          if (isActive) activeLink = link;
        });
        return activeLink;
      };

      const toggleMenu = (forceClose = false) => {
        const shouldClose = forceClose || isOpen;

        clearTimeout(openTimeout);

        if (shouldClose) {
          menu.classList.remove("is-open");
          header.classList.remove("is-menu-open");
          scrollLock.unlock(600);
          isOpen = false;
        } else {
          scrollLock.lock();
          openTimeout = setTimeout(() => {
            menu.classList.add("is-open");
            header.classList.add("is-menu-open");
            isOpen = true;
            // Update indicator when menu opens
            setTimeout(() => updateIndicator(getActiveLink()), 100);
          }, 50);
        }
      };

      btn.onclick = (e) => {
        e.stopPropagation();
        toggleMenu();
      };

      mobileLinks.forEach((link) => {
        link.addEventListener("click", () => toggleMenu(true));
      });

      const handleResize = () => {
        if (window.innerWidth >= 768 && isOpen) {
          toggleMenu(true);
        } else if (isOpen) {
          updateIndicator(getActiveLink());
        }
      };
      window.addEventListener("resize", handleResize);
    }
  };

  const setupDesktopNav = () => {
    const nav = document.getElementById("desktop-nav");
    const indicator = document.getElementById("nav-indicator");
    const links = document.querySelectorAll("[data-nav-link]");

    if (!nav || !indicator) return;

    const updateIndicator = (el: Element | null) => {
      if (el) {
        const target = el as HTMLElement;
        const rect = target.getBoundingClientRect();
        const navRect = nav.getBoundingClientRect();

        indicator.style.width = `${rect.width}px`;
        indicator.style.height = `${rect.height}px`;
        indicator.style.left = `${rect.left - navRect.left}px`;
        indicator.style.top = `${rect.top - navRect.top}px`;
        indicator.style.opacity = "1";
      } else {
        indicator.style.opacity = "0";
      }
    };

    const getActiveLink = () => {
      const pathname = window.location.pathname;
      const normalizePath = (path: string) => path.replace(/\/$/, "") || "/";
      const currentPath = normalizePath(pathname);

      let activeLink: Element | null = null;
      links.forEach((link) => {
        const href = link.getAttribute("data-href");
        const isActive =
          href === "/" ? currentPath === "/" : currentPath.startsWith(href!);
        if (isActive) activeLink = link;
      });
      return activeLink;
    };

    // Initial position - only update to active link
    setTimeout(() => {
      updateIndicator(getActiveLink());
    }, 100);

    // Remove mouseenter/mouseleave movement listeners to prevent indicator from following hover
    window.addEventListener("resize", () => {
      updateIndicator(getActiveLink());
    });
  };

  const updateActiveLinks = () => {
    const pathname = window.location.pathname;
    const normalizePath = (path: string) => path.replace(/\/$/, "") || "/";
    const currentPath = normalizePath(pathname);

    // Desktop links
    document.querySelectorAll("[data-nav-link]").forEach((link) => {
      const href = link.getAttribute("data-href");
      const isActive =
        href === "/" ? currentPath === "/" : currentPath.startsWith(href!);

      if (isActive) {
        link.classList.add("text-[#3F89FC]");
        link.classList.remove("text-gray-300", "hover:text-white");
      } else {
        link.classList.remove("text-[#3F89FC]");
        link.classList.add("text-gray-300", "hover:text-white");
      }
    });

    // Mobile links
    document.querySelectorAll("[data-mobile-link]").forEach((link) => {
      const href = link.getAttribute("data-href");
      const isActive =
        href === "/" ? currentPath === "/" : currentPath.startsWith(href!);

      if (isActive) {
        link.classList.add("text-[#3F89FC]");
        link.classList.remove("text-gray-300", "hover:text-white");
      } else {
        link.classList.remove("text-[#3F89FC]");
        link.classList.add("text-gray-300", "hover:text-white");
      }
    });
  };

  document.addEventListener("astro:page-load", () => {
    updateActiveLinks();
    initProgressBar();
    setupMobileMenu();
    setupDesktopNav();
    // Ensure scroll is unlocked on page load if it was locked
    scrollLock.clear();
  });
</script>
